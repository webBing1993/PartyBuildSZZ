{extend name="public/common"}

{block name="style"}
<title>党建直播</title>
<link rel="stylesheet" href="/static/sweetalert/sweetalert1.css">
<script src="/static/sweetalert/sweetalert1.min.js"></script>
<style>
    .scrollDiy{
        position: absolute;
        top:50vw ;
        bottom: 12vw;
        overflow-y: scroll;
        /* 增加该属性，可以增加弹性 */
        -webkit-overflow-scrolling: touch;
        width:100%;
    }
    .scrollDiy::-webkit-scrollbar {
        /*为了隐藏掉滚轮*/
        display: none;
    }
    video{
        width:100vw;
        /*display:none;*/
        height:50vw;
    }
    .tabs {
        width: 100vw;
        height: 10.8vw;
        padding: 2.1vw 0;
        background: #e4e4e4;
        position: absolute;
        z-index: 99;
        top:50vw;
        text-align: center;
    }
    .tabs .tab {
        display: inline-block;
        height: 100%;
        color: #333333;
        font-size: 1.5rem;
        line-height: 7.6vw;
        text-align: center;
        background: #a3a3a3;
        color: #fff;
        padding: 0 4vw;
    }
    .tabs-tab{
        display: inline-block;
        border-radius: 1.5vw;
    }
    .tabs .tab:first-child{
        border-bottom-left-radius:1.5vw;
        border-top-left-radius:1.5vw;
    }
    .tabs .tab:last-child{
        margin-left: -1.5vw;
        border-bottom-right-radius:1.5vw;
        border-top-right-radius:1.5vw;
    }
    .tabs .active {
        background: #fff;
        color: #ff460b;
    }
    .area{
        margin: 3vw 3vw;
        padding: 3vw 2vw;
        padding-right: 4vw;
    }
    .area .areapeople div{
        display: inline-block;
        width: 38vw;
        text-align: center;
        background: #f4f4f4;
        border-radius: 1.5vw;
    }
    .area div span:first-child{
        width: 17vw;
        display: inline-block;
    }
    .welcome{
        padding: 2vw 3vw;
        height:10vw;
        line-height:5vw;
    }
    .comment .lists .list:last-child{
        padding-bottom: 5.4vw;
    }
    .welcome img{
        width:5vw;
        height:5vw;
        position: relative;
        top:1px;
    }
    .welcome span{
        color: #ff460b;
        padding-left: 1.5vw;
    }


    #videoBox {
        width: 100%;
        top:0;
        position: absolute;
        height: 50vw;
    }

    #playBtn {
        position: absolute;
        left: 0;
        top: 0;
        display: block;
        border: none;
        background: url("/home/images/live/playBtn.png") center no-repeat;
        z-index: 1000;
        width: 100%;
        background-size: 20vw;
        height: 50vw;
    }

    #poster {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        z-index: 100;
        height: 50vw;
    }
    .totalnum{
        color: #fff;
        margin-left: 6vw;
        margin-top: 3vw;
        position: absolute;
        top: 40vw;
        right: 1vw;
        border-radius: 1.5vw;
        background: rgba(0,0,0,0.7);
        height: 6vw;
        line-height: 6vw;
        padding: 0 2.4vw;
        z-index: 99999;
    }
    #loading{
        text-align: center;
        line-height: 50vw;
        font-size: 1.6rem;
        display: none;
        position: absolute;
        width: 100%;
    }
    .chat{
        background:#f4f4f4 ;
    }
    .comment .lists .list{
        border-bottom: none;
        padding-left: 1.5vw;
    }
    .comment .lists .list .fl img{
        width: 10.7vw;
        height: 10.7vw;
        margin-top: 3vw;
        margin-right: 2vw;
        margin-bottom: 3vw;
        overflow: hidden;
        -webkit-border-radius: 1.5vw;
        border-radius: 1.5vw;
        float: left;
    }

    .comment .lists .list .mid .time {
        font-size: 1.2rem;
        color: #6d6d6d;
    }
    .comment .lists .list .mid .name {
        padding-right: 1.5vw;
        font-size: 1.2rem;
        color: #6d6d6d;
        padding-left: 1.5vw;
    }
    .comment .lists .list .mid .content{
        color: #1c1c1c;
        padding-left: 1.5vw;
        padding-right: 1.5vw;
    }
    .mid{
        background: #fff;
        border-radius: 1.5vw;
        float: left;
        margin-top: 3vw;
        max-width: 80vw;
        padding: 1.5vw;
    }
    /*底部*/
    .bottom {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: 12vw;
        padding:0 3vw;
        border-top: 1px solid #f1f1f1;
        background: #ffffff;
        font-family: "Microsoft YaHei", sans-serif;
    }
    .bottom .star {
        background: url('/home/images/detail/star-border.png') 5.4vw 3.4vw no-repeat;
    }
    .bottom .star_ {
        animation: shake 300ms ease;
        -webkit-animation: shake 300ms ease;
        background: url('/home/images/detail/star-yellow.png') 5.4vw 3.4vw no-repeat;
    }
    .bottom .collect {
        width: 16.2vw;
        height: 100%;
        font-size: 1.2rem;
        text-align: center;
        background-size: 5.4vw 5.4vw;
        padding-top: 6.4vw;
    }
    .bottom .myword input {
        vertical-align: middle;
        height: 8vw;
        width: 94vw;
        margin: 1.7vw 0;
        padding-left: 2.4vw;
        background: #fafafa;
        border: 1px solid #d8d8d8;
        -webkit-border-radius: 1.6vw;
        border-radius: 1.6vw;
    }
    input::-webkit-input-placeholder{
        color: #000;
    }
    .areapeople{
        margin-top:61.8vw;
    }
    .bottom .send {
        width: 20.5vw;
        line-height: 12vw;
        text-align: center;
    }
    .bottom .send:active {
        background: #fafafa;
    }
    .hidden{
        display: none;
    }
</style>

{/block}
<!--css一处 scrollDiy标签一对 tofixed()注释  scrollNow 跟scrollDiy滚动绑定-->
{block name="body"}
<!--<video src="{$live_path}" controls="controls" webkit-playsinline="true" playsinline></video>-->
<div id="videoBox">
    <p id="loading">加载中...</p>
    <p id="total"><p class="totalnum">在线人数：<em style="color: #ff480f;font-style: normal" >0</em> / {$live_sum}</p></p>
    <video id="videoLive" preload="auto" poster=""   webkit-playsinline="true" x-webkit-airplay="true" playsinline="true">
        <source src="{$live_path}">
    </video>
    <input id="playBtn" type="button" value="">
    <img id="poster" src="/home/images/learn/banner.png" alt="">
</div>

    <div class="notice chat scrollDiy" >
        <div class="welcome">
            <img src="/home/images/live/tips.png">
            <span>系统提示：欢迎来到本直播间！</span>
        </div>
        <div class="comment">
        <div class="lists">
        </div>
        </div>
    </div>
    <div class="notice area hidden">
        <div class="areapeople">
            <span style="color: #ff480f;">10</span>
            <span style="color: #312927;"> /20</span>
        </div>
    </div>
</div>
{eq name="visit" value="0"}
<div class="bottom clear" onclick="tosend(this,7,1)">
    <div class="myword fl">
        <input type="text" placeholder="说说你的感想！" disabled>
    </div>
</div>
{/eq}

{/block}

{block name="script"}
<script src="/home/js/reset.js"></script>
<script>
    var iWindowWidth;
    var iWindowHeight;
    window.onresize = function () {
        autoWH();
        myPlayer.style.width = iWindowWidth + "px";
        myPlayer.style.height = iWindowHeight + "px";
    }
    //获取videojs生成的video
    var myPlayer = document.getElementById("videoLive");
    //播放按钮
    var oPlayBtn = document.getElementById("playBtn");
    //获取视频盒子
    var oVideoBox = document.getElementById("videoBox");
    //获取滚动盒子
    var oScrollBox = document.getElementById("scrollBox");
    //遮罩图片
    var oPoster = document.getElementById("poster");
    //图片加载完
    oPoster.onload = function () {
        oVideoBox.style.height = oPoster.offsetHeight + "px";
    }
    document.getElementById("videoBox").addEventListener('touchmove', function (e) {
        e.preventDefault();
    }, false);
    function autoWH() {
        //获取可视区宽度
        iWindowWidth = $(window).width();
        //获取可视区高度
        iWindowHeight = $(window).height();
    }
    autoWH();

    //播放按钮呗点击
    oPlayBtn.onclick = function () {
        myPlayer.play();
//        this.style.display = oPoster.style.display =  "none";
        loading.style.display = "block";
    };
    //监听播放
    myPlayer.addEventListener('play', function () {
        setTimeout(function(){
            if (!$('video')[0].duration) {
                oPlayBtn.style.display = oPoster.style.display =  loading.style.display ="block";
                loading.style.display = "none";
                swal({
                    title: ' ',
                    text: '直播还未开始哦!',
                    type: 'error',
                    confirmButtonText:'确定',
                    timer:3000
                });
                myPlayer.pause();
                return false
            } else {
                loading.style.display = "none";
            }
        },5000)
    }, false);
    //监听暂停
    myPlayer.addEventListener('pause', function () {
//        alert("暂停");
    }, false);
    //监听结束
    myPlayer.addEventListener('ended', function () {
//        alert("结束");
    }, false);
</script>
<script>
    var set1= null;
    $(function(){
            // 初始化数据
            chat();
            people();
            setInterval(chat,1500);
            setInterval(people,2500);
    });

    //发送评论
    var tosend = function(e,type,id){
        var index = $(e).parents('.votes ul li' ).index();
        swal({
                    title: "",
                    text: "请输入评论内容！",
                    type: "input",
                    showCancelButton: true,
                    animation: "slide-from-top",
                    inputPlaceholder: "",
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    closeOnConfirm: false
                },
                function(inputValue){
                    if (inputValue === false) {
                        $(".bottom").show();
                        setTimeout(function(){
                            $("input").blur();
                        },0)
                        return false
                    }else if (inputValue === "" || inputValue.length<1)
                    {
                        swal.showInputError("评论不少于1个字");
                        return false
                    }else if(inputValue.length>300){
                        swal.showInputError("评论不得多于300字");
                    }else{
                        $.ajax({
                            type:"post",
                            url:"{:Url('Base/comment')}",
                            data:{
                                type : type,
                                aid:id,
                                content:inputValue
                            },
                            success:function(msg){
                                inputValue="";
                                swal({
                                    title: ' ',
                                    text: '评论成功',
                                    type: 'success',
                                    confirmButtonText:'确定',
                                    timer:3000
                                });
                            }
                        });
                    }
                    setTimeout(function(){
                        $("input").blur();
                    },0)
                });
    };

    // 获取聊天评论
    var chat = function() {
        // 等待响应
        if (set1) {return '';}
        set1 = true;

        if ($(".list").length == 0) {
            var id = 0;
        } else {
            var id = $(".list:first").attr('data-id');
        }
        $.ajax({
            type: "post",
            url: "{:Url('Live/getComment')}",
            data: {
                id: id
            },
            beforeSend: function (XMLHttpRequest) {

            },
            success: function (data) {
                set1 = false;
                if (data.code == 1) {

                    addComment(data);
                }
            }
        })
    }


    function addComment(data){
        //is_like : 1为已点赞 0为未点赞
        var html = '';
        var lists = data.data;
        var len = lists.length;
        for(var i = 0; i< len;i++){
            var list = lists[i];
            var userid = "'"+list.create_user+"'";
            html += '<div class="list clear" data-id="'+list['id']+'">'+
                    '<div class="fl">'+
                    '<img src="'+list.header+'" alt="用户" class="user">'+
                    '</div>'+
                    '<div class="mid">'+
                    '<span class="name limit">'+ list.nickname+'</span>'+
                    '<span class="time">('+ list.time+')</span>'+
                    '<div class="content" >'+ list.content+'</div>'+
                    '</div>';
            html+=
                    '</div>';
        }
        $(".lists" ).prepend(html);
    }

    // 在线人数
    var people = function() {
        $.ajax({
            type: "post",
            url: "{:Url('Live/getOnlineNumber')}",
            data: {
            },
            beforeSend: function (XMLHttpRequest) {

            },
            success: function (data) {
                if (data.code == 1) {
                   $('.totalnum em').html(data.data);
                }
            }
        })
    }

    var u = navigator.userAgent;
    var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
    var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
    if (isiOS) {
        $('video source').css({
            'object-position': ' 0px 0px',
            'width': '100%',
            'height': '50vw'
        });
    } else {
        $('video').css({
            'object-position': ' 0px 0px',
            'width': '100%'
        });
    }
</script>
{/block}